<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BookPage</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

</head>
<body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<div class="container" style="margin-top: 50px">
    <div class="row">
        <div class="col-md-5 mx-auto">
            <div id="first">
                <div class="myform form ">
                    <div class="logo mb-3">
                        <div class="col-md-12 text-center">
                            <h2><th:block th:text="${book.getBookname()}"/></h2>
                            <p id = "stars"></p>
                        </div>
                    </div>

                    <br>
                    ISBN:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                    <th:block th:text="${book.isbn}"/>
                    <br>
                    Book author:&nbsp
                    <th:block th:text="${book.author}"/>
                    <br/>
                    <div id="buttons" th:if="${#authorization.expression('hasAuthority(''USER'')')}">
                        <div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
    <div  style="margin-top: 20px">
        <form id="add-comment" class="form-inline">
            <input name="comm" class="mym m form-control" placeholder="Comment">
            <select name="rat" class="mym m form-control">
                <option value='1'> 1 </option>
                <option value='2'> 2 </option>
                <option value='3'> 3 </option>
                <option value='4'> 4 </option>
                <option value='5'> 5 </option>
            </select>
            <button type="submit" class="btn m">Submit</button>
        </form>
    </div>
    <div id="comments" style="margin-top: 20px">
        <table width="70%" class="table table-bordered">
            <thead>
            <td>User</td>
            <td>Оцінка</td>
            <td>Відгук</td>
            </thead>
            <tbody id="commentsTable"></tbody>
        </table>
    </div>
</div>

<script>
    var bookId, bookname, author, isbn;

    $(function () {
        $(document).ready(function () {
            var path = window.location.pathname;
            bookId = path.substring(path.lastIndexOf('/') + 1);
            $.ajax({
                type: 'GET',
                url: '/booklist/isFavorite/' + bookId,
                success: function (response) {
                    var $buttons = $('#buttons');
                    if (response) {
                        $buttons.append('<button onclick=' + "\"deleteFav()\"" + '>Delete from Favorites</button>');
                    }
                    else {
                        $buttons.append('<button onclick=' + "\"addFav()\"" + '>Add to Favorites</button>');
                    }
                }
            });
            $.ajax({
                type: 'GET',
                url: '/bookpage/' + bookId,
                success: function (response) {
                    bookname = response.bookname;
                    author = response.author;
                    isbn = response.isbn;
                }
            });
        });

    });
    $(function () {
        $(document).ready(function () {
            $.ajax({
                type: 'GET',
                url: 'comments',
                success: function (response) {
                    var $table = $('#commentsTable');
                    $table.empty();
                    response.forEach(function (comment) {
                            $table.append('<tr><td>' + comment.user  + '</td><td>' + comment.stars + '</td><td>' +comment.text + '</td></tr>');
                        }
                    )
                }
            });
        });
    });

    $(function () {
        $(document).ready(function () {
            $.ajax({
                type: 'GET',
                url: '/comments',
                success: function (response) {

                    var res = 0;
                    var i =0;

                    response.forEach(function (comm) {
                            res+=comm.rating;
                            i++;
                        }
                    )
                    res=res/i;
                    $('#stars').text(res+"/5");
                },
                error: function (response) {
                    $('#stars').text("Немає жодної оцінки");
                }
            });
        });
    });



    function addFav() {
        $.ajax({
            type: 'PUT',
            url: '/booklist/favorites/add',
            data: JSON.stringify({
                id: bookId,
                name: bookname,
                author: author,
                isbn: isbn
            }),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Content-Type', 'application/json')
            },
            success: function () {
                window.location.reload();
            }
        });
    }

    function deleteFav() {
        $.ajax({
            type: 'DELETE',
            url: '/booklist/favorites/delete',
            data: JSON.stringify({
                id: bookId,
                name: bookname,
                author: author,
                isbn: isbn
            }),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Content-Type', 'application/json')
            },
            success: function () {
                window.location.reload();
            }
        });
    }
    $('#add-comment').submit(function (e) {
        e.preventDefault();

        $.ajax({
            type: 'POST',
            url: '/comments/add',
            dataType: 'json',
            data: {
                text: $(this).find('[name=comm]').val(),
                stars: $(this).find('[name=rat]').val(),
                book: bookname
            },
            success: function (response) {
                var $table = $('#commentsTable');
                $table.empty();
                var res = 0;
                var i =0;

                response.forEach(function (comment) {
                        $table.append('<tr><td>' + comment.user  + '</td><td>' + comment.rating + '</td><td>' +comment.text + '</td></tr>');
                    i++;
                    res+=comment.rating;
                }
                );
                res=res/i;
                $('#stars').text(res+"/5");
            }
        });
    });
</script>
</body>
</html>